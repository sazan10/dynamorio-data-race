name: Build and Test DynamoRIO Client

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc g++ make

    - name: Download DynamoRIO
      run: |
        wget https://github.com/DynamoRIO/dynamorio/releases/download/cronbuild-10.93.19944/DynamoRIO-Linux-10.93.19944.tar.gz
        tar -xzf DynamoRIO-Linux-10.93.19944.tar.gz
        export DYNAMORIO_DIR=$(pwd)/DynamoRIO-Linux-10.93.19944
        echo "DynamoRIO directory: $DYNAMORIO_DIR"

    - name: Compile Client
      run: |
        $DYNAMORIO_DIR/bin64/drrun -c ./simple_client.c -- ./simple_target

    - name: Run Client
      run: |
        $DYNAMORIO_DIR/bin64/drrun -c ./simple_client -- ./simple_target
